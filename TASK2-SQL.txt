TASK 2: 
(1) Calcolare l'ammontare delle vendite per l'azienda nei periodi 2016-2017-2018 utilizzando le tabelle Orders ed Orders Details.
(2) Separare i paesi in base all'ammontare delle vendite per 3 categorie: basso, medio e alto. 
    Decidere la soglia di ciascuna categoria in base alla distribuzione normale delle vendite e/o soglie empiriche giustificate in base ai dati

(1)
-- COMPANY REVENUES 2016(PER 2017 E 2018 BASTA CAMBIARE LA CONDIZIONE NELLA WHERE) CALCOLATI CON 3 DIVERSE, MA EQUIVALENTI, QUERY:
SELECT SUM(od.UnitPrice * od.Quantity) AS revenue_2016
FROM "Order Details" od 
JOIN Orders o on od.OrderID = o.OrderID 
WHERE o.OrderDate LIKE '2016%';

SELECT SUM(od.UnitPrice * od.Quantity) AS revenue_2016
FROM "Order Details" od 
JOIN Orders o on od.OrderID = o.OrderID 
WHERE o.OrderDate BETWEEN '2016-01-01' AND '2016-12-31';

SELECT SUM(od.UnitPrice * od.Quantity) AS revenue_2016
FROM "Order Details" od 
JOIN Orders o on od.OrderID = o.OrderID 
WHERE o.OrderDate >= '2016-01-01' AND o.OrderDate <= '2016-12-31';

NOTA: PER LE INFORMAZIONI ESTRATTE ERA SUFFICIENTE UTILIZZARE SOLTANTO LA TABELLA ORDER DETAILS.
      È POSSIBILE ESTRARRE INFORMAZIONI SULLE DATE E SUI PAESI MEDIANTE L'UTILIZZO DELLA TABELLA ORDERS (ATTRIBUTI ORDERDATE, SHIPCOUNTRY):

SELECT o.ShipCountry, o.OrderDate, od.UnitPrice,  od.Quantity
FROM "Order Details" od 
JOIN Orders o on od.OrderID = o.OrderID 
WHERE o.OrderDate LIKE '2016%'
ORDER BY o.OrderDate;

-- Revenue paese per data

SELECT o.ShipCountry, o.OrderDate, od.UnitPrice * od.Quantity AS Date_Revenue
FROM "Order Details" od 
JOIN Orders o on od.OrderID = o.OrderID 
WHERE o.OrderDate LIKE '2016%'
GROUP BY o.ShipCountry
ORDER BY o.OrderDate;

-- Revenue complessivo paese Anno 2016

SELECT o.ShipCountry, SUM(od.UnitPrice * od.Quantity) AS Tot_Revenue, SUBSTR(o.OrderDate, 1, 4) AS anno
FROM "Order Details" od 
JOIN Orders o on od.OrderID = o.OrderID 
WHERE o.OrderDate LIKE '2016%'
GROUP BY o.ShipCountry
ORDER BY o.OrderDate;

--------------------------------------------------------------------------------------------------------------------

-- 2016
WITH T AS
(SELECT 
    c.Country, 
    SUM(od.UnitPrice * od.Quantity) AS revenue,
    substr(o.OrderDate,1,4) AS anno
 FROM "Order Details" od 
 JOIN Orders o ON od.OrderID = o.OrderID 
 JOIN Customers c on o.CustomerID=c.CustomerID 
 WHERE o.OrderDate LIKE '2016%'
 GROUP BY c.Country )
 
SELECT 
    T.Country, 
    revenue, anno,
CASE WHEN revenue < (select (max(revenue*0.35)) from T) THEN 'LOW'   -- se la revenue del paese è < TOT% MAX(revenue_2018) -> LOW   -> TOT% = 35%MAX
     WHEN revenue < (select (max(revenue*0.75)) from T) THEN 'MEDIUM' --  se la revenue del paese è < TOT1% MAX(revenue 2018) -> MEDIUM -> TOT% = 75%MAX
     ELSE 'HIGH'
     END AS THRESHOLD
FROM T
ORDER BY revenue

-- 2017
WITH T AS
(SELECT 
    c.Country, 
    SUM(od.UnitPrice * od.Quantity) AS revenue,
    substr(o.OrderDate,1,4) AS anno
 FROM "Order Details" od 
 JOIN Orders o ON od.OrderID = o.OrderID 
 JOIN Customers c on o.CustomerID=c.CustomerID 
 WHERE o.OrderDate LIKE '2017%'
 GROUP BY c.Country )
 
SELECT 
    T.Country, 
    revenue, anno,
CASE WHEN revenue < (select (max(revenue*0.35)) from T) THEN 'LOW'   -- se la revenue del paese è < TOT% MAX(revenue_2018) -> LOW   -> TOT% = 35%MAX
     WHEN revenue < (select (max(revenue*0.75)) from T) THEN 'MEDIUM' --  se la revenue del paese è < TOT1% MAX(revenue 2018) -> MEDIUM -> TOT% = 75%MAX
     ELSE 'HIGH'
     END AS THRESHOLD
FROM T
ORDER BY revenue

--2018
WITH T AS
(SELECT 
    c.Country, 
    SUM(od.UnitPrice * od.Quantity) AS revenue,
    substr(o.OrderDate,1,4) AS anno
 FROM "Order Details" od 
 JOIN Orders o ON od.OrderID = o.OrderID 
 JOIN Customers c on o.CustomerID=c.CustomerID 
 WHERE o.OrderDate LIKE '2018%'
 GROUP BY c.Country )
 
SELECT 
    T.Country, 
    t.revenue,
    anno,
CASE WHEN revenue < (select (max(revenue*0.35)) from T) THEN 'LOW'   -- se la revenue del paese è < TOT% MAX(revenue_2018) -> LOW   -> TOT% = 35%MAX
     WHEN revenue < (select (max(revenue*0.75)) from T) THEN 'MEDIUM' --  se la revenue del paese è < TOT1% MAX(revenue 2018) -> MEDIUM -> TOT% = 75%MAX
     ELSE 'HIGH'
     END AS THRESHOLD
FROM T
ORDER BY revenue

##
Abbiamo notato che i periodi di riferimento inseriti nel Database circa le revenue dei singoli anni differiscono tra loro in modo sostanziale.
Per l'anno 2016, il periodo di riferimento va da 04/07/2016 al 31/12/2016.
Per l'anno 2017, il periodo di riferimento va da 01/01/2017 al 31/12/2017.
Per l'anno 2018, il periodo di riferimento va da 01/01/2018 al 06/05/2018.

Per ovviare a questa discrepanza, abbiamo pensato di creare un criterio sfruttando la variazione del massimo della revenue affidandoci ad un rapporto
percentuale, in modo tale da creare un set di threshold che in autonomia si adatta alla variazione dei dati.

se la revenue del paese è < TOT% MAX(revenue_2018) -> LOW   -> TOT% = 35%MAX
se la revenue del paese è < TOT1% MAX(revenue 2018) -> MEDIUM -> TOT% = 75%MAX

bassi medi  alti
35% +  40%  +25% = 100%

        75   100


